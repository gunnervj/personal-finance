# Frontend layer: Next.js
#
# Requires infra and services to be running first.
#
# Deploy / redeploy (rebuilds image):
#   docker compose -f docker-compose.frontend.yml up -d --build

networks:
  finance-net:
    external: true
    name: personal-finance-net

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_KEYCLOAK_URL: ${KEYCLOAK_URL:-http://localhost:8080}
        NEXT_PUBLIC_KEYCLOAK_REALM: personal-finance
        NEXT_PUBLIC_KEYCLOAK_CLIENT_ID: frontend
        NEXT_PUBLIC_USER_SERVICE_URL: ${USER_SERVICE_URL:-http://localhost:8081}
        NEXT_PUBLIC_BUDGET_SERVICE_URL: ${BUDGET_SERVICE_URL:-http://localhost:8082}
        NEXT_PUBLIC_TRANSACTION_SERVICE_URL: ${TRANSACTION_SERVICE_URL:-http://localhost:8083}
    networks:
      - finance-net
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      NEXTAUTH_URL: ${FRONTEND_URL:-http://localhost:3000}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-dev-secret-change-in-production-min-32-chars}
      KEYCLOAK_ID: frontend
      KEYCLOAK_SECRET: ""
      # External issuer - must match 'iss' claim in JWT tokens
      KEYCLOAK_ISSUER: ${KEYCLOAK_ISSUER:-http://keycloak:8080/realms/personal-finance}
      # Internal issuer - used for OIDC discovery inside Docker
      KEYCLOAK_INTERNAL_ISSUER: ${KEYCLOAK_INTERNAL_URL:-http://keycloak:8080}/realms/personal-finance
      NODE_TLS_REJECT_UNAUTHORIZED: ${NODE_TLS_REJECT_UNAUTHORIZED:-}
      # Server-side URLs (internal Docker network)
      USER_SERVICE_URL: http://user-service:8081
      BUDGET_SERVICE_URL: http://budget-service:8082
      TRANSACTION_SERVICE_URL: http://transaction-service:8083
      # Public browser-side URLs
      NEXT_PUBLIC_KEYCLOAK_URL: ${KEYCLOAK_URL:-http://localhost:8080}
      NEXT_PUBLIC_KEYCLOAK_REALM: personal-finance
      NEXT_PUBLIC_KEYCLOAK_CLIENT_ID: frontend
      NEXT_PUBLIC_USER_SERVICE_URL: ${USER_SERVICE_URL:-http://localhost:8081}
      NEXT_PUBLIC_BUDGET_SERVICE_URL: ${BUDGET_SERVICE_URL:-http://localhost:8082}
      NEXT_PUBLIC_TRANSACTION_SERVICE_URL: ${TRANSACTION_SERVICE_URL:-http://localhost:8083}
